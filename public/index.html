<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Due Network</title>
    <link rel="icon" type="image/png" href="favicon_DUE.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #000000;
            --secondary: #666666;
            --border: #EAEAEA;
            --bg: #FAFAFA;
            --white: #FFFFFF;
            --accent: #0F4A3C;
            --reply-bg: #F8F9FA;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .btn {
            background-color: var(--accent);
            color: var(--white);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--primary);
        }

        .btn-outline:hover {
            border-color: var(--secondary);
        }

        input,
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            box-sizing: border-box;
            background: var(--white);
            font-size: 0.95em;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        #auth-view {
            max-width: 360px;
            margin: 80px auto;
            text-align: center;
        }

        .auth-toggle {
            margin-top: 15px;
            font-size: 0.85em;
            cursor: pointer;
            color: var(--secondary);
        }

        .auth-toggle:hover {
            text-decoration: underline;
            color: var(--primary);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-weight: 600;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent);
        }

        .post-meta {
            font-size: 0.85em;
            color: var(--secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-author {
            font-weight: 600;
            color: var(--primary);
        }

        .reply-meta {
            font-size: 0.9em;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .reply-link {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }

        .post-content {
            font-size: 1em;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ff4757;
            cursor: pointer;
            font-size: 0.75em;
            padding: 2px 6px;
        }

        .user-menu {
            position: relative;
            cursor: pointer;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85em;
        }

        .dropdown {
            position: absolute;
            top: 40px;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: none;
            flex-direction: column;
            width: 140px;
            overflow: hidden;
            z-index: 100;
        }

        .dropdown.show {
            display: flex;
        }

        .dropdown-item {
            padding: 10px 15px;
            text-align: left;
            background: none;
            border: none;
            width: 100%;
            cursor: pointer;
            font-size: 0.9em;
        }

        .dropdown-item:hover {
            background: var(--bg);
        }

        .post-actions {
            display: flex;
            gap: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            align-items: center;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--secondary);
            font-size: 0.85em;
            padding: 0;
            transition: color 0.2s;
        }

        .action-btn:hover {
            color: var(--accent);
        }

        .action-btn svg {
            width: 18px;
            height: 18px;
            fill: none;
            stroke: currentColor;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .action-btn.liked {
            color: #e74c3c;
        }

        .action-btn.liked svg {
            fill: #e74c3c;
            stroke: #e74c3c;
        }

        .reply-toggle {
            font-size: 0.85em;
            color: var(--accent);
            cursor: pointer;
            margin-top: 0;
            margin-left: auto;
            border: none;
            background: none;
            font-weight: 500;
        }

        .reply-toggle:hover {
            text-decoration: underline;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(2px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .post-reply {
            margin-left: 20px;
            margin-top: 10px;
            padding: 12px;
            background: var(--reply-bg);
            border-radius: 8px;
            border-left: 2px solid var(--border);
            font-size: 0.9em;
        }

        .replies-wrapper {
            margin-top: 10px;
            display: none;
        }

        .replies-wrapper.show {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="auth-view">
            <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 40px;">
                <img src="favicon_DUE.png" alt="Due Network Logo" style="height: 80px; margin-bottom: 20px;">
                <h1 class="logo" style="margin: 0; font-size: 1.5em;">DUE-NETWORK</h1>
            </div>
            <div id="login-form">
                <input type="email" id="login-email" placeholder="Email address">
                <input type="password" id="login-password" placeholder="Password">
                <button class="btn" style="width: 100%; margin-top: 10px;" onclick="handleLogin()">Sign In</button>
                <div class="auth-toggle" onclick="toggleAuth('register')">Create an account</div>
            </div>
            <div id="register-form" style="display: none;">
                <input type="text" id="reg-name" placeholder="Full Name">
                <input type="email" id="reg-email" placeholder="Email address">
                <input type="password" id="reg-password" placeholder="Password">
                <button class="btn" style="width: 100%; margin-top: 10px;" onclick="handleRegister()">Register</button>
                <div class="auth-toggle" onclick="toggleAuth('login')">Already have an account? Sign In</div>
            </div>
        </div>

        <div id="app-view" style="display: none;">
            <header>
                <div class="logo">
                    <img src="favicon_DUE.png" alt="Logo" style="height: 32px;">
                    DUE-NETWORK
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn" onclick="openPostModal()">New Post</button>

                    <div class="user-menu" onclick="toggleUserMenu()">
                        <div class="user-avatar" id="user-initials"></div>
                        <div class="dropdown" id="user-dropdown">
                            <div style="padding: 12px 16px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.9em;"
                                id="dropdown-name"></div>
                            <button class="dropdown-item" onclick="logout()">Sign Out</button>
                        </div>
                    </div>
                </div>
            </header>

            <div id="posts-container">
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="post-modal">
        <div class="modal">
            <h3 id="modal-title" style="margin-top: 0; margin-bottom: 20px;">Create Post</h3>
            <textarea id="post-content" rows="4" placeholder="What's on your mind?"></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-outline" onclick="closePostModal()">Cancel</button>
                <button class="btn" onclick="handleCreatePost()">Post</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let currentUser = null;
        let replyToId = null;
        let allPostsCache = [];

        checkAuth();

        function checkAuth() {
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            if (token && userStr) {
                currentUser = JSON.parse(userStr);
                showApp();
            } else {
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('auth-view').style.display = 'block';
            document.getElementById('app-view').style.display = 'none';
        }

        function showApp() {
            document.getElementById('auth-view').style.display = 'none';
            document.getElementById('app-view').style.display = 'block';
            document.getElementById('user-initials').textContent = getInitials(currentUser.name);
            document.getElementById('dropdown-name').textContent = currentUser.name;
            loadPosts();
        }

        function toggleAuth(mode) {
            if (mode === 'register') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            } else {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('register-form').style.display = 'none';
            }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    window.location.reload();
                } else {
                    alert(data.msg || 'Login failed');
                }
            } catch (err) {
                alert('Connection error');
            }
        }

        async function handleRegister() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;

            if (!name || !email || !password) return alert("All fields required");

            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                const data = await res.json();

                if (res.ok) {
                    toggleAuth('login');
                    alert('Registration successful! Please login.');
                } else {
                    alert(data.msg || 'Registration failed');
                }
            } catch (err) {
                alert('Connection error');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.reload();
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('show');
        }

        window.onclick = function (event) {
            if (!event.target.closest('.user-menu')) {
                const dropdowns = document.getElementsByClassName("dropdown");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        async function loadPosts() {
            const container = document.getElementById('posts-container');
            container.innerHTML = '<div style="text-align:center; color:#999;">Loading...</div>';

            try {
                const res = await fetch(`${API_URL}/posts`);
                allPostsCache = await res.json();

                renderFeed(allPostsCache);
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p style="text-align:center; color:red;">Failed to load posts.</p>';
            }
        }

        function renderFeed(posts) {
            const container = document.getElementById('posts-container');
            container.innerHTML = '';

            if (posts.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#999; margin-top:40px;">No posts yet. Be the first!</div>';
                return;
            }

            const roots = posts.filter(p => !p.replyTo);

            roots.forEach(post => {
                container.appendChild(createPostElement(post, posts));
            });
        }

        function createPostElement(post, allPosts, level = 0) {
            const isMine = post.author && post.author._id === currentUser.id;
            const date = new Date(post.createdAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            const isLiked = post.likes.includes(currentUser.id);

            const el = document.createElement('div');

            if (level > 0) {
                el.className = 'post-reply';
            } else {
                el.className = 'card';
            }

            const contentHtml = `
                <div class="post-meta">
                    <span class="post-author">${post.author ? post.author.name : 'Unknown'}</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>${date}</span>
                        ${isMine ? `<button class="delete-btn" onclick="event.stopPropagation(); deletePost('${post._id}')">DELETE</button>` : ''}
                    </div>
                </div>
                <div class="post-content">${post.content}</div>
                
                <div class="post-actions">
                    <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="event.stopPropagation(); toggleLike('${post._id}')">
                        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span>${post.likes.length}</span>
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); openReplyModal('${post._id}', '${post.author ? post.author.name : 'Unknown'}')">
                        <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                        <span>Reply</span>
                    </button>
                </div>
            `;

            el.innerHTML = contentHtml;

            const children = allPosts.filter(p => p.replyTo && (typeof p.replyTo === 'object' ? p.replyTo._id : p.replyTo) === post._id);
            children.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

            if (children.length > 0) {
                const actionsDiv = el.querySelector('.post-actions');
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'reply-toggle';
                toggleBtn.innerHTML = `Show ${children.length} Repl${children.length > 1 ? 'ies' : 'y'}`;
                toggleBtn.onclick = (e) => {
                    e.stopPropagation();
                    const wrapper = el.querySelector('.replies-wrapper');
                    wrapper.classList.toggle('show');
                    toggleBtn.textContent = wrapper.classList.contains('show') ? 'Hide Replies' : `Show ${children.length} Repl${children.length > 1 ? 'ies' : 'y'}`;
                };
                actionsDiv.appendChild(toggleBtn);

                const repliesContainer = document.createElement('div');
                repliesContainer.className = 'replies-wrapper';

                children.forEach(child => {
                    repliesContainer.appendChild(createPostElement(child, allPosts, level + 1));
                });

                el.appendChild(repliesContainer);
            }

            return el;
        }

        async function toggleLike(postId) {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL}/posts/like`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ postId })
                });
                if (res.ok) loadPosts();
            } catch (err) {
                console.error(err);
            }
        }

        async function handleCreatePost() {
            const content = document.getElementById('post-content').value;
            if (!content) return;

            const token = localStorage.getItem('token');
            const body = { content };
            if (replyToId) {
                body.replyTo = replyToId;
            }

            try {
                const res = await fetch(`${API_URL}/posts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    closePostModal();
                    loadPosts();
                } else {
                    alert('Failed to post');
                }
            } catch (err) {
                alert('Error creating post');
            }
        }

        async function deletePost(id) {
            if (!confirm("Delete this post?")) return;
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL}/posts/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) loadPosts();
            } catch (e) {
                alert("Error deleting");
            }
        }

        function openPostModal() {
            replyToId = null;
            document.getElementById('modal-title').textContent = "Create Post";
            document.getElementById('post-content').value = '';
            document.getElementById('post-content').placeholder = "What's on your mind?";
            document.getElementById('post-modal').style.display = 'flex';
        }

        function openReplyModal(postId, authorName) {
            replyToId = postId;
            document.getElementById('modal-title').textContent = `Reply to @${authorName}`;
            document.getElementById('post-content').value = '';
            document.getElementById('post-content').placeholder = "Tweet your reply";
            document.getElementById('post-modal').style.display = 'flex';
        }

        function closePostModal() { document.getElementById('post-modal').style.display = 'none'; }
    </script>
</body>

</html>